---
// Floating particles using tsparticles - magical rising spores
---

<div id="floating-particles" aria-hidden="true"></div>

<script>
  import { tsParticles } from "@tsparticles/engine";
  import { loadSlim } from "@tsparticles/slim";
  import confetti from 'canvas-confetti';

  // Check for reduced motion preference
  const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

  if (!prefersReducedMotion) {
    // Load the slim bundle
    await loadSlim(tsParticles);

    const container = await tsParticles.load({
      id: "floating-particles",
      options: {
        fullScreen: {
          enable: false,
          zIndex: 0
        },
        particles: {
          number: {
            value: 30,
            density: {
              enable: true,
              height: 800,
              width: 800
            }
          },
          color: {
            value: ["#4ade80", "#2dd4bf", "#facc15", "#86efac", "#059669", "#0d9488"]
          },
          shape: {
            type: "circle"
          },
          opacity: {
            value: { min: 0.4, max: 0.7 },
            animation: {
              enable: true,
              speed: 0.5,
              sync: false,
              mode: "auto"
            }
          },
          size: {
            value: { min: 3, max: 6 },
            animation: {
              enable: true,
              speed: 2,
              sync: false,
              mode: "auto"
            }
          },
          move: {
            enable: true,
            speed: { min: 0.5, max: 1.5 },
            direction: "top",
            straight: false,
            random: true,
            outModes: {
              default: "out"
            },
            path: {
              enable: true,
              delay: {
                value: 0
              },
              options: {
                freq: 0.05,
                amp: 10
              }
            }
          },
          wobble: {
            enable: true,
            distance: 5,
            speed: 5
          }
        },
        interactivity: {
          detectsOn: "window",
          events: {
            onHover: {
              enable: true,
              mode: "bubble"
            }
          },
          modes: {
            bubble: {
              distance: 200,
              size: 10,
              duration: 2,
              opacity: 0.8,
              color: "#ffffff"
            }
          }
        },
        detectRetina: true,
        fpsLimit: 60,
        smooth: true
      }
    });

    // Manual click-to-pop handler
    if (container) {
      window.addEventListener('click', (e) => {
        const x = e.clientX;
        const y = e.clientY;
        
        // Handle Retina/High-DPI screens
        // tsParticles internal coordinates are usually in device pixels when detectRetina is true
        const pixelRatio = container.retina.pixelRatio ?? window.devicePixelRatio ?? 1;

        // v3: container.particles might not be an array directly
        // Use filter to get all particles
        const particles = container.particles.filter(() => true);
        
        // Check backwards to pop top particles first
        for (let i = particles.length - 1; i >= 0; i--) {
          const p = particles[i];
          const pos = p.getPosition();
          
          // Convert particle position to logical CSS pixels
          const px = pos.x / pixelRatio;
          const py = pos.y / pixelRatio;
          
          // Calculate distance in CSS pixels
          const dist = Math.sqrt(Math.pow(x - px, 2) + Math.pow(y - py, 2));
          
          // Hitbox: 30px radius (precise)
          if (dist < 30) {
            // Pop!
            container.particles.remove(p);
            
            // Visual feedback
            const normalizeX = x / window.innerWidth;
            const normalizeY = y / window.innerHeight;
            
            // Safe color palette
            const colors = ["#4ade80", "#2dd4bf", "#facc15", "#86efac", "#059669"];
            
            confetti({
              particleCount: 15,
              spread: 40,
              origin: { x: normalizeX, y: normalizeY },
              colors: colors,
              disableForReducedMotion: true,
              startVelocity: 15,
              gravity: 0.8,
              ticks: 100,
              shapes: ['circle']
            });
            
            break; 
          }
        }
      });
    }
  }
</script>

<style>
  #floating-particles {
    position: fixed;
    inset: 0;
    z-index: -1;
    pointer-events: none;
  }

  @media (prefers-reduced-motion: reduce) {
    #floating-particles {
      display: none;
    }
  }
</style>
