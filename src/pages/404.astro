---
import BaseLayout from '../layouts/BaseLayout.astro';
import { t, locales, localeAliasMap, type Locale } from '../i18n';

const locale = 'en';

// All translations for client-side locale switching
const translations: Record<string, { title: string; description: string; backHome: string }> = {};
for (const loc of locales) {
  translations[loc] = {
    title: t('notFound.title', loc),
    description: t('notFound.description', loc),
    backHome: t('notFound.backHome', loc),
  };
}
// Also add aliases that map to their base locales
for (const [alias, baseLoc] of Object.entries(localeAliasMap)) {
  translations[alias] = translations[baseLoc];
}

// Generate locale paths
const localePaths: Record<string, string> = { en: '/' };
for (const loc of locales) {
  if (loc !== 'en') {
    localePaths[loc] = `/${loc}/`;
  }
}
// Add aliases
for (const alias of Object.keys(localeAliasMap)) {
  localePaths[alias] = `/${alias}/`;
}
---

<BaseLayout
  title={t('notFound.meta.title', locale)}
  description={t('notFound.meta.description', locale)}
  locale={locale}
>
  <section class="not-found" aria-labelledby="not-found-heading">
    <div class="deep-woods-overlay"></div>
    <div class="will-o-wisps">
      <span></span><span></span><span></span>
    </div>
    
    <div class="badger-background">
      <img src="/images/logo-face-only-large.png" alt="" aria-hidden="true" />
    </div>
    <div class="container not-found-content">
      <h1 class="not-found-title" id="not-found-heading">
        <span aria-hidden="true">404</span>
        <span class="sr-only" data-i18n="title">{t('notFound.title', locale)}</span>
      </h1>
      <p class="not-found-subtitle" data-i18n="title" aria-hidden="true">{t('notFound.title', locale)}</p>
      <p class="not-found-description" data-i18n="description">{t('notFound.description', locale)}</p>
      <a href="/" class="btn btn-primary btn-lg" data-i18n-href="home">
        <span data-i18n="backHome">{t('notFound.backHome', locale)}</span>
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
          <polyline points="9 22 9 12 15 12 15 22"></polyline>
        </svg>
      </a>
    </div>
  </section>

  <script define:vars={{ translations, localePaths }}>
    const LOCALE_KEY = 'preferred-locale';
    let targetLocale = localStorage.getItem(LOCALE_KEY);

    // If no stored preference, try to detect from URL path
    if (!targetLocale) {
      const pathSegments = window.location.pathname.split('/').filter(Boolean);
      if (pathSegments.length > 0) {
        const urlLocale = pathSegments[0];
        if (translations[urlLocale]) {
          targetLocale = urlLocale;
        }
      }
    }

    if (targetLocale && translations[targetLocale]) {
      const t = translations[targetLocale];

      // Update text content (both visible and sr-only versions)
      document.querySelectorAll('[data-i18n="title"]').forEach(el => {
        el.textContent = t.title;
      });
      document.querySelector('[data-i18n="description"]').textContent = t.description;
      document.querySelector('[data-i18n="backHome"]').textContent = t.backHome;

      // Update home link to localized path
      const homeLink = document.querySelector('[data-i18n-href="home"]');
      if (homeLink && localePaths[targetLocale]) {
        homeLink.href = localePaths[targetLocale];
      }

      // Update html lang attribute
      document.documentElement.lang = targetLocale;
    }
  </script>
</BaseLayout>

<style>
  .not-found {
    min-height: 80vh;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    overflow: hidden;
    /* Darker mysterious background for 404 */
    background: radial-gradient(circle at center, #1a4d2e 0%, #052e16 100%);
  }

  .deep-woods-overlay {
    position: absolute;
    inset: 0;
    background-image: 
      linear-gradient(to bottom, rgba(0,0,0,0.2), rgba(0,0,0,0.6)),
      url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%239C92AC' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    z-index: 0;
  }

  .badger-background {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    pointer-events: none;
    z-index: 1;
  }

  .badger-background img {
    width: min(80vw, 600px);
    height: auto;
    opacity: 0.1;
    filter: grayscale(50%) blur(1px);
    animation: float 8s ease-in-out infinite;
    mask-image: radial-gradient(circle, black 40%, transparent 80%);
  }

  @keyframes float {
    0%, 100% { transform: translateY(0) scale(1); }
    50% { transform: translateY(-20px) scale(1.02); }
  }

  .will-o-wisps span {
    position: absolute;
    width: 10px;
    height: 10px;
    background: #4ade80;
    border-radius: 50%;
    filter: blur(8px);
    opacity: 0.6;
    animation: wisp-float 10s infinite;
    z-index: 2;
  }
  
  .will-o-wisps span:nth-child(1) { top: 30%; left: 20%; animation-delay: 0s; background: #60a5fa; }
  .will-o-wisps span:nth-child(2) { top: 60%; left: 70%; animation-delay: -3s; background: #facc15; }
  .will-o-wisps span:nth-child(3) { top: 40%; left: 80%; animation-delay: -6s; }

  @keyframes wisp-float {
    0%, 100% { transform: translate(0, 0); opacity: 0.4; }
    50% { transform: translate(30px, -30px); opacity: 0.8; }
  }

  .not-found-content {
    position: relative;
    z-index: 5;
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--space-md);
  }

  .not-found-title {
    font-size: clamp(6rem, 20vw, 12rem);
    font-weight: 900;
    line-height: 1;
    background: linear-gradient(135deg, #86efac 0%, #22c55e 50%, #15803d 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin: 0;
    text-shadow: 0 0 40px rgba(34, 197, 94, 0.3);
    letter-spacing: -0.05em;
  }

  .not-found-subtitle {
    font-size: clamp(1.5rem, 4vw, 2.5rem);
    font-weight: 700;
    color: #f0fdf4;
    margin: 0;
    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
  }

  .not-found-description {
    font-size: clamp(1rem, 2vw, 1.25rem);
    color: #bbf7d0;
    max-width: 40ch;
    margin: 0;
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
  }

  .btn {
    margin-top: var(--space-md);
    display: inline-flex;
    align-items: center;
    gap: var(--space-sm);
    box-shadow: 0 0 20px rgba(34, 197, 94, 0.4);
  }

  @media (prefers-reduced-motion: reduce) {
    .badger-background img, .will-o-wisps span {
      animation: none;
    }
  }
</style>
